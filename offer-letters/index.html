<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Offer Letter Dashboard | VisionAstraa</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PDF-Lib -->
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .loader {
            border-top-color: #3498db;
            -webkit-animation: spinner 1.5s linear infinite;
            animation: spinner 1.5s linear infinite;
        }
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Custom scrollbar for the long role dropdown on desktop */
        select option {
            padding: 8px;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans pb-10">

    <div class="container mx-auto px-4 py-4 md:py-8 max-w-5xl">
        
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-sm md:shadow-lg p-4 md:p-6 mb-6 md:mb-8 border-l-4 border-blue-600">
            <h1 class="text-xl md:text-2xl font-bold text-gray-800 flex items-center">
                <i class="fas fa-file-signature mr-3 text-blue-600"></i>
                VisionAstraa EV Academy - Offer Letter Generator
            </h1>
            <p class="text-sm md:text-base text-gray-600 mt-1 md:mt-2">Generate Offer Letters and send emails directly.</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 md:gap-8">
            
            <!-- Form Section -->
            <div class="bg-white rounded-lg shadow-sm md:shadow-lg p-4 md:p-6 order-1">
                <h2 class="text-lg md:text-xl font-semibold mb-4 text-gray-700 border-b pb-2">Candidate Details</h2>
                
                <form id="offerForm" class="space-y-4 md:space-y-5">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Candidate Name</label>
                        <input type="text" id="candidateName" placeholder="Type name here..." class="w-full px-4 py-3 md:py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-colors" required>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Candidate Email</label>
                        <input type="email" id="candidateEmail" placeholder="Type email here..." class="w-full px-4 py-3 md:py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-colors" required>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Internship Role</label>
                        <select id="candidateRole" class="w-full px-3 py-3 md:py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none text-xs md:text-sm bg-white" required>
                            <option value="">Select a Role...</option>
                            <option value="Full Stack Development for Electric Vehicle">Full Stack Development for Electric Vehicle</option>
                            <option value="Full Stack Development for EV">Full Stack Development for EV</option>
                            <option value="Web Development for Electric Vehicle">Web Development for Electric Vehicle</option>
                            <option value="Web Development for EV">Web Development for EV</option>
                            <option value="Data Science for Electric Vehicle">Data Science for Electric Vehicle</option>
                            <option value="Data Science for EV">Data Science for EV</option>
                            <option value="DESIGN & DEVELOPMENT OF ELECTRIC VEHICLE ( Mechanical , Mechatronics , Automobile )">DESIGN & DEVELOPMENT OF ELECTRIC VEHICLE</option>
                            <option value="EMBEDDED SYSTEMS FOR ELECTRIC VEHICLE ( Microcontrollers , IOT , Mechatronics , ADAS )">EMBEDDED SYSTEMS FOR ELECTRIC VEHICLE</option>
                            <option value="AI/ML FOR ELECTRIC VEHICLE ( Data Science , Cyber Security , Machine Learning , Data Analytics , Full Stack Development , Artificial intelligence )">AI/ML FOR ELECTRIC VEHICLE</option>
                            <option value="DESIGN & DEVELOPMENT OF EV ( Mechanical , Mechatronics , Automobile )">DESIGN & DEVELOPMENT OF EV</option>
                            <option value="EMBEDDED SYSTEMS FOR EV ( Microcontrollers , Mechatronics , IOT , ADAS )">EMBEDDED SYSTEMS FOR EV</option>
                            <option value="AI/ML FOR EV ( Data Science , Cybersecurity , Machine Learning , Data Analytics , Full Stack Development , Artificial intelligence )">AI/ML FOR EV</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">Select the exact role from the dropdown.</p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Sender Account</label>
                        <select id="senderAccount" class="w-full px-3 py-3 md:py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none text-sm bg-white">
                            <option value="1">visionastraa@evinternships.com</option>
                            <option value="2">visionastraa@evinternships.in</option>
                        </select>
                    </div>

                    <div class="pt-2 md:pt-4">
                        <button type="submit" id="sendBtn" class="w-full bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white font-bold py-3.5 px-4 rounded-lg transition duration-200 flex justify-center items-center shadow-md">
                            <span id="btnText">Generate & Send Offer</span>
                            <div id="btnLoader" class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-6 w-6 ml-3 hidden"></div>
                        </button>
                    </div>
                </form>
                
                <div id="statusMessage" class="mt-4 hidden p-3 rounded text-sm break-words"></div>
            </div>

            <!-- Preview Section -->
            <div class="bg-gray-50 rounded-lg shadow-sm md:shadow-lg p-4 md:p-6 flex flex-col items-center justify-center min-h-[300px] md:min-h-[400px] border-2 border-dashed border-gray-300 order-2">
                <div id="previewIconContainer" class="text-center">
                    <i class="fas fa-file-pdf text-5xl md:text-6xl text-gray-300 mb-4"></i>
                    <h3 class="text-base md:text-lg font-medium text-gray-500">PDF Preview</h3>
                    <p class="text-xs md:text-sm text-gray-400 text-center mt-2 px-4">Generated PDF status will appear here.</p>
                </div>
                
                <div id="pdfDownloadLink" class="mt-4 hidden w-full text-center">
                    <div class="bg-white p-4 rounded border border-gray-200 shadow-sm inline-block">
                        <i class="fas fa-check-circle text-green-500 text-3xl mb-2"></i>
                        <p class="text-sm text-gray-700 font-medium mb-2">PDF Generated Successfully</p>
                        <a href="#" class="inline-block bg-gray-800 text-white text-sm px-4 py-2 rounded hover:bg-gray-700 transition">
                            <i class="fas fa-download mr-1"></i> Download PDF
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { PDFDocument, StandardFonts, rgb } = PDFLib;

        // Configuration
        const TEMPLATE_URL = 'Template.pdf';

        // Helper: Word Wrap & Draw Logic
        // This function mimics ReportLab's paragraph flow
        async function drawRichText(page, textSegments, startX, startY, maxWidth, fontSize, lineHeight, regularFont, boldFont) {
            let currentX = startX;
            let currentY = startY;

            for (const segment of textSegments) {
                const font = segment.bold ? boldFont : regularFont;
                // Preserve spaces better by splitting on space but keeping delimiters
                const words = segment.text.split(/(\s+)/); 

                for (const word of words) {
                    if (word === '') continue;
                    
                    const wordWidth = font.widthOfTextAtSize(word, fontSize);

                    // Check if word fits in current line
                    if (currentX + wordWidth > startX + maxWidth) {
                        // Move to next line
                        currentX = startX;
                        currentY -= lineHeight;
                        
                        // If the causing word is just a space, ignore it on the new line start
                        if (/^\s+$/.test(word)) continue;
                    }

                    page.drawText(word, {
                        x: currentX,
                        y: currentY,
                        size: fontSize,
                        font: font,
                        color: rgb(0, 0, 0),
                    });

                    currentX += wordWidth;
                }
            }
        }

        document.getElementById('offerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const name = document.getElementById('candidateName').value;
            const email = document.getElementById('candidateEmail').value;
            const role = document.getElementById('candidateRole').value;
            const account = document.getElementById('senderAccount').value;
            const btn = document.getElementById('sendBtn');
            const btnText = document.getElementById('btnText');
            const btnLoader = document.getElementById('btnLoader');
            const statusDiv = document.getElementById('statusMessage');
            const previewIcon = document.getElementById('previewIconContainer');
            const downloadContainer = document.getElementById('pdfDownloadLink');

            // UI Loading State
            btn.disabled = true;
            btnText.innerText = 'Processing...';
            btnLoader.classList.remove('hidden');
            statusDiv.classList.add('hidden');
            downloadContainer.classList.add('hidden');
            previewIcon.classList.remove('hidden');

            try {
                // 1. Load Template
                const existingPdfBytes = await fetch(TEMPLATE_URL).then(res => {
                    if (!res.ok) throw new Error("Template.pdf not found in current directory");
                    return res.arrayBuffer();
                });

                const pdfDoc = await PDFDocument.load(existingPdfBytes);
                const pages = pdfDoc.getPages();
                const firstPage = pages[0];
                const { width, height } = firstPage.getSize();
                const font = await pdfDoc.embedFont(StandardFonts.TimesRoman);
                const boldFont = await pdfDoc.embedFont(StandardFonts.TimesRomanBold);

                // 2. Define Layout Constants
                const fontSize = 14;
                const lineHeight = 18;
                const leftMargin = 45;
                const maxWidth = 520;
                const topStart = height * 0.775; 

                // 3. Define Content Segments
                const contentSegments = [
                    { text: "Dear ", bold: false },
                    { text: name, bold: true },
                    { text: ",\n\n", bold: false },
                    
                    { text: "We are pleased to offer you an Internship in ", bold: false },
                    { text: role, bold: true },
                    { text: " at ", bold: false },
                    { text: "VisionAstraa EV Academy", bold: true },
                    { text: " with effect from January 2026. We are excited to welcome you onboard.\n\n", bold: false },

                    { text: "As an Intern, you will be part of a collaborative environment where you will learn and contribute to impactful projects in the electric vehicle (EV) domain. You will gain hands-on experience and have the opportunity to apply your academic knowledge to real-world applications while developing practical skills that will strengthen your career prospects.\n\n", bold: false },

                    { text: "At ", bold: false },
                    { text: "VisionAstraa EV Academy", bold: true },
                    { text: ", we are committed to a supportive and enriching learning environment. Our aim is to empower you with relevant, hands-on experience and to support your growth in the EV industry.\n\n", bold: false },

                    { text: "We look forward to working with you and hope this internship will be a valuable step in your professional journey.", bold: false }
                ];

                // 4. Draw Content
                let currentX = leftMargin;
                let currentY = topStart;

                for (const segment of contentSegments) {
                    const parts = segment.text.split('\n');
                    for (let i = 0; i < parts.length; i++) {
                        const partText = parts[i];
                        if (partText.length > 0) {
                            const fontToUse = segment.bold ? boldFont : font;
                            
                            // Rich Text Wrapping Logic
                            const words = partText.split(/(\s+)/);
                            for (const word of words) {
                                if (word === '') continue;
                                const wordWidth = fontToUse.widthOfTextAtSize(word, fontSize);

                                if (currentX + wordWidth > leftMargin + maxWidth) {
                                    currentX = leftMargin; // Reset X
                                    currentY -= lineHeight; // New Line
                                    if (/^\s+$/.test(word)) continue; // Skip leading space on new line
                                }

                                firstPage.drawText(word, { x: currentX, y: currentY, size: fontSize, font: fontToUse, color: rgb(0,0,0) });
                                currentX += wordWidth;
                            }
                        }
                        
                        if (i < parts.length - 1) {
                            currentX = leftMargin;
                            currentY -= lineHeight;
                        }
                    }
                }

                // 5. Save & Send
                const pdfBytes = await pdfDoc.save();
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                
                // Show Download Link in Preview Area
                const pdfUrl = URL.createObjectURL(blob);
                const linkTag = downloadContainer.querySelector('a');
                linkTag.href = pdfUrl;
                linkTag.download = `Offer_Letter_${name.replace(/\s+/g, '_')}.pdf`;
                previewIcon.classList.add('hidden');
                downloadContainer.classList.remove('hidden');

                // Send to Backend
                const reader = new FileReader();
                reader.readAsDataURL(blob); 
                reader.onloadend = async function() {
                    const base64data = reader.result.split(',')[1];
                    const formData = new FormData();
                    formData.append('pdf_data', base64data);
                    formData.append('name', name);
                    formData.append('email', email);
                    formData.append('role', role);
                    formData.append('account_id', account);

                    try {
                        const response = await fetch('send_offer.php', { method: 'POST', body: formData });
                        const result = await response.json();
                        if (result.success) {
                            statusDiv.innerHTML = `<div class="flex items-start"><i class="fas fa-check-circle mt-1 mr-2 text-green-600"></i><span><strong>Success:</strong> ${result.message}</span></div>`;
                            statusDiv.className = "mt-4 p-3 rounded text-sm bg-green-50 border border-green-200 text-green-800 block";
                            document.getElementById('offerForm').reset();
                        } else {
                            throw new Error(result.message);
                        }
                    } catch (err) {
                        statusDiv.innerHTML = `<div class="flex items-start"><i class="fas fa-exclamation-circle mt-1 mr-2 text-red-600"></i><span><strong>Error:</strong> ${err.message}</span></div>`;
                        statusDiv.className = "mt-4 p-3 rounded text-sm bg-red-50 border border-red-200 text-red-800 block";
                    } finally {
                        btn.disabled = false;
                        btnText.innerText = 'Generate & Send Offer';
                        btnLoader.classList.add('hidden');
                    }
                }

            } catch (error) {
                console.error(error);
                statusDiv.innerHTML = `<span class="text-red-600 font-bold">System Error: ${error.message}</span>`;
                statusDiv.className = "mt-4 p-3 rounded text-sm bg-red-100 border border-red-400 block";
                btn.disabled = false;
                btnText.innerText = 'Generate & Send Offer';
                btnLoader.classList.add('hidden');
            }
        });
    </script>
</body>
</html>